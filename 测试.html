
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色彩重塑 - GPT-4o 图片批量色彩矫正工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FE1110',
                        'primary-transparent': 'rgba(254, 17, 16, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }
        
        .thumbnail:hover {
            transform: translateY(-5px);
        }
        
        .thumbnail.selected {
            outline: 3px solid #FE1110;
        }
        
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e0e0e0;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FE1110;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        
        .range-slider::-webkit-slider-thumb:hover {
            background: #d10c0b;
        }
        
        .range-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FE1110;
            cursor: pointer;
            transition: background 0.15s ease;
            border: none;
        }
        
        .range-slider::-moz-range-thumb:hover {
            background: #d10c0b;
        }
        
        .logo-animation {
            animation: fadeIn 1.5s ease-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .author-button {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 100;
            transition: transform 0.2s ease;
        }
        
        .author-button:hover {
            transform: translateY(-3px);
        }
        
        .scroll-down {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) translateX(-50%);
            }
            40% {
                transform: translateY(-20px) translateX(-50%);
            }
            60% {
                transform: translateY(-10px) translateX(-50%);
            }
        }

        .comparison-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .comparison-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Loading Screen -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="logo-animation text-center">
            <div class="text-[42px] font-extrabold text-primary">
                色彩重塑
            </div>
            <div class="text-[18px] mt-1">
                COLOR RESHAPE
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="w-full h-screen flex flex-col justify-center items-center px-6">
            <div class="max-w-4xl w-full text-center">
                <h1 class="text-[42px] font-extrabold">
                    色彩重塑
                    <span class="block text-[20px] font-normal mt-1">COLOR RESHAPE</span>
                </h1>
                
                <p class="mt-4 text-xl">
                    AI图像批量色彩矫正工具
                </p>
                <p class="mt-2 text-lg text-gray-600">
                    解锁GPT-4o生成图像的真实色彩
                </p>
                
                <div id="uploadArea" class="mt-12 border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-primary transition-colors">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                    <p class="mt-4 text-lg">拖放图片到这里上传</p>
                    <p class="mt-2 text-gray-500">或点击选择文件</p>
                </div>
                
                <button id="uploadButton" class="mt-6 bg-primary text-white px-6 py-3 rounded-full font-medium hover:bg-opacity-90 transition-all flex items-center mx-auto">
                    <i class="fas fa-upload mr-2"></i> 批量上传
                </button>
                
                <input type="file" id="fileInput" class="hidden" multiple accept="image/*">
            </div>
            
            <div class="scroll-down text-primary">
                <i class="fas fa-chevron-down text-2xl"></i>
            </div>
        </header>

        <!-- Introduction Section -->
        <section id="intro" class="py-20 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-[42px] font-extrabold text-primary mb-10">
                    解锁真实色彩
                    <span class="block text-[18px] font-normal mt-1 text-primary opacity-80">UNLOCK TRUE COLORS</span>
                </div>
                
                <p class="text-lg leading-relaxed mb-8">
                    GPT-4o 生成的图像虽然创意无限，但常常存在色彩偏差问题 — 过于偏蓝、缺乏活力、色调不自然。「色彩重塑」工具专为解决这一痛点而生，通过精准的色彩平衡算法，让您的 AI 作品焕发真实光彩。
                </p>
                
                <h2 class="text-2xl font-bold mt-12 mb-6">一键提升，批量处理</h2>
                
                <p class="text-lg leading-relaxed mb-8">
                    拖放即用，无需繁琐操作。上传数十张图片，系统自动识别色偏并进行智能矫正，几秒钟内完成所有处理。无论是创意项目还是商业需求，「色彩重塑」都能让您的 AI 视觉作品从此告别"AI 感"。
                </p>
                
                <div class="mt-16 mb-12">
                    <div class="text-[28px] font-bold">
                        专业级调整 
                        <span class="text-[16px] font-normal ml-2">PROFESSIONAL ADJUSTMENT</span>
                    </div>
                </div>
                
                <p class="text-lg leading-relaxed mb-8">
                    不满足于自动校正？我们提供完整的色彩控制面板，让您能够精确调整阴影、中间调和高光区域的红、绿、蓝通道参数，实现完美色彩平衡，打造专业级视觉效果。
                </p>
                
                <p class="text-lg leading-relaxed mb-8">
                    立即体验，让您的 GPT-4o 图像媲美专业摄影师的色彩表现力。
                </p>
                
                <p class="text-xl font-bold mt-12">
                    「色彩重塑」— 让 AI 图像焕发真实光彩
                </p>
            </div>
        </section>

        <!-- Image Processing Area -->
        <section id="imageProcessingArea" class="hidden py-16 px-6 bg-gray-50">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold mb-2">
                    色彩调整
                    <span class="text-lg font-normal ml-2">COLOR ADJUSTMENT</span>
                </h2>
                
                <!-- Thumbnails Gallery -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">已上传图片</h3>
                    <div id="thumbnailsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- Thumbnails will be added here -->
                    </div>
                </div>
                
                <!-- Image Comparison - Two Cards Side by Side -->
                <div class="mt-16">
                    <h3 class="text-xl font-semibold mb-4">预览与调整</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Before Card -->
                        <div class="comparison-card bg-white shadow-md rounded-lg overflow-hidden">
                            <div class="py-3 px-4 bg-gray-100 border-b border-gray-200">
                                <h4 class="font-medium text-gray-800">原始图片</h4>
                                <p class="text-xs text-gray-500">调整前</p>
                            </div>
                            <div class="p-4">
                                <div id="beforeImageContainer" class="relative w-full aspect-video bg-gray-100 flex justify-center items-center overflow-hidden rounded">
                                    <img id="beforeImage" class="max-w-full max-h-full object-contain" src="" alt="原始图片">
                                </div>
                            </div>
                        </div>
                        
                        <!-- After Card -->
                        <div class="comparison-card bg-white shadow-md rounded-lg overflow-hidden">
                            <div class="py-3 px-4 bg-primary bg-opacity-10 border-b border-primary border-opacity-20">
                                <h4 class="font-medium text-primary">处理后图片</h4>
                                <p class="text-xs text-gray-500">应用色彩矫正</p>
                            </div>
                            <div class="p-4">
                                <div id="afterImageContainer" class="relative w-full aspect-video bg-gray-100 flex justify-center items-center overflow-hidden rounded">
                                    <img id="afterImage" class="max-w-full max-h-full object-contain" src="" alt="处理后图片">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Color Adjustment Controls -->
                <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Shadows -->
                    <div class="p-6 bg-white rounded-lg shadow-sm">
                        <h4 class="text-lg font-bold mb-4">阴影区域</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>青色-红色</span>
                                    <span id="shadowRedValue">-5</span>
                                </div>
                                <input type="range" min="-20" max="20" value="-5" class="range-slider" id="shadowRed">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>洋红-绿色</span>
                                    <span id="shadowGreenValue">0</span>
                                </div>
                                <input type="range" min="-20" max="20" value="0" class="range-slider" id="shadowGreen">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>黄色-蓝色</span>
                                    <span id="shadowBlueValue">10</span>
                                </div>
                                <input type="range" min="-20" max="20" value="10" class="range-slider" id="shadowBlue">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Midtones -->
                    <div class="p-6 bg-white rounded-lg shadow-sm">
                        <h4 class="text-lg font-bold mb-4">中间调区域</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>青色-红色</span>
                                    <span id="midtoneRedValue">-6</span>
                                </div>
                                <input type="range" min="-20" max="20" value="-6" class="range-slider" id="midtoneRed">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>洋红-绿色</span>
                                    <span id="midtoneGreenValue">0</span>
                                </div>
                                <input type="range" min="-20" max="20" value="0" class="range-slider" id="midtoneGreen">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>黄色-蓝色</span>
                                    <span id="midtoneBlueValue">20</span>
                                </div>
                                <input type="range" min="-20" max="20" value="20" class="range-slider" id="midtoneBlue">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Highlights -->
                    <div class="p-6 bg-white rounded-lg shadow-sm">
                        <h4 class="text-lg font-bold mb-4">高光区域</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>青色-红色</span>
                                    <span id="highlightRedValue">-6</span>
                                </div>
                                <input type="range" min="-20" max="20" value="-6" class="range-slider" id="highlightRed">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>洋红-绿色</span>
                                    <span id="highlightGreenValue">0</span>
                                </div>
                                <input type="range" min="-20" max="20" value="0" class="range-slider" id="highlightGreen">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>黄色-蓝色</span>
                                    <span id="highlightBlueValue">15</span>
                                </div>
                                <input type="range" min="-20" max="20" value="15" class="range-slider" id="highlightBlue">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-12 flex flex-wrap gap-4 justify-center">
                    <button id="applyToAllBtn" class="bg-primary text-white px-6 py-3 rounded-full font-medium hover:bg-opacity-90 transition-all flex items-center">
                        <i class="fas fa-magic mr-2"></i> 应用到所有
                    </button>
                    
                    <button id="downloadBtn" class="bg-gray-800 text-white px-6 py-3 rounded-full font-medium hover:bg-opacity-90 transition-all flex items-center">
                        <i class="fas fa-download mr-2"></i> 下载图片
                    </button>
                    
                    <button id="resetBtn" class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-full font-medium hover:bg-gray-50 transition-all flex items-center">
                        <i class="fas fa-undo mr-2"></i> 重置调整
                    </button>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Author Button -->
    <a href="https://x.com/op7418" target="_blank" class="author-button bg-white text-gray-900 px-4 py-2 rounded-full shadow-md flex items-center">
        <span class="font-medium">歸藏</span>
        <i class="fas fa-external-link-alt ml-2 text-xs"></i>
    </a>

    <script>
        // Global variables
        let images = [];
        let currentImageIndex = 0;
        const defaultSettings = {
            shadow: { red: -5, green: 0, blue: 10 },
            midtone: { red: -6, green: 0, blue: 20 },
            highlight: { red: -6, green: 0, blue: 15 }
        };
        let settings = JSON.parse(JSON.stringify(defaultSettings));
        
        // Wait for page to load
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading animation
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                }, 500);
            }, 2000);
            
            // Initialize UI elements
            initUI();
        });
        
        function initUI() {
            // Upload area functionality
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadButton.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
            });
            
            // Initialize other buttons
            document.getElementById('applyToAllBtn').addEventListener('click', applyToAllImages);
            document.getElementById('downloadBtn').addEventListener('click', downloadImages);
            document.getElementById('resetBtn').addEventListener('click', resetSettings);
            
            // Initialize sliders
            initSliders();
        }
        
        function initSliders() {
            // Shadow sliders
            document.getElementById('shadowRed').addEventListener('input', (e) => {
                document.getElementById('shadowRedValue').textContent = e.target.value;
                settings.shadow.red = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('shadowGreen').addEventListener('input', (e) => {
                document.getElementById('shadowGreenValue').textContent = e.target.value;
                settings.shadow.green = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('shadowBlue').addEventListener('input', (e) => {
                document.getElementById('shadowBlueValue').textContent = e.target.value;
                settings.shadow.blue = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            // Midtone sliders
            document.getElementById('midtoneRed').addEventListener('input', (e) => {
                document.getElementById('midtoneRedValue').textContent = e.target.value;
                settings.midtone.red = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('midtoneGreen').addEventListener('input', (e) => {
                document.getElementById('midtoneGreenValue').textContent = e.target.value;
                settings.midtone.green = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('midtoneBlue').addEventListener('input', (e) => {
                document.getElementById('midtoneBlueValue').textContent = e.target.value;
                settings.midtone.blue = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            // Highlight sliders
            document.getElementById('highlightRed').addEventListener('input', (e) => {
                document.getElementById('highlightRedValue').textContent = e.target.value;
                settings.highlight.red = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('highlightGreen').addEventListener('input', (e) => {
                document.getElementById('highlightGreenValue').textContent = e.target.value;
                settings.highlight.green = parseInt(e.target.value);
                updateCurrentImage();
            });
            
            document.getElementById('highlightBlue').addEventListener('input', (e) => {
                document.getElementById('highlightBlueValue').textContent = e.target.value;
                settings.highlight.blue = parseInt(e.target.value);
                updateCurrentImage();
            });
        }
        
        function handleFiles(fileList) {
            if (fileList.length === 0) return;
            
            // Convert FileList to Array and filter image files
            const filesArray = Array.from(fileList).filter(file => file.type.startsWith('image/'));
            
            if (filesArray.length === 0) {
                alert('请上传图片文件');
                return;
            }
            
            // Show processing section
            document.getElementById('imageProcessingArea').classList.remove('hidden');
            document.getElementById('imageProcessingArea').scrollIntoView({ behavior: 'smooth' });
            
            // Clear previous images
            images = [];
            document.getElementById('thumbnailsContainer').innerHTML = '';
            
            // 初始化图片数组以匹配文件数量
            images = new Array(filesArray.length);
            let loadedCount = 0;
            
            // Process each file
            filesArray.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create Image object to get dimensions
                    const img = new Image();
                    img.onload = function() {
                        // 将图片数据存储在与文件索引相对应的位置
                        images[index] = {
                            original: e.target.result,
                            filename: file.name,
                            width: img.width,
                            height: img.height,
                            processed: null,
                            settings: JSON.parse(JSON.stringify(defaultSettings)),
                            index: index // 添加索引属性以便追踪
                        };
                        
                        // Create thumbnail with correct index association
                        addThumbnail(e.target.result, index);
                        
                        loadedCount++;
                        
                        // If this is the first image, display it
                        if (loadedCount === 1) {
                            selectImage(index);
                        }
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        function addThumbnail(src, index) {
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            
            const thumbnail = document.createElement('div');
            thumbnail.className = 'thumbnail cursor-pointer';
            thumbnail.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = src;
            img.className = 'w-full h-auto object-cover aspect-square';
            
            thumbnail.appendChild(img);
            thumbnailsContainer.appendChild(thumbnail);
            
            thumbnail.addEventListener('click', () => {
                selectImage(index);
            });
        }
        
        function selectImage(index) {
            // 确保索引有效并且对应的图片已加载
            if (index >= images.length || !images[index]) {
                console.warn('尝试选择无效的图片索引:', index);
                return;
            }
            
            // Update selected thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('selected');
            });
            
            const selectedThumb = document.querySelector(`.thumbnail[data-index="${index}"]`);
            if (selectedThumb) {
                selectedThumb.classList.add('selected');
            }
            
            // Update current index
            currentImageIndex = index;
            
            // Update sliders with image-specific settings
            updateSliders(images[index].settings);
            
            // Process and display the selected image
            updateCurrentImage();
        }
        
        function updateSliders(imageSettings) {
            // Update slider values
            document.getElementById('shadowRed').value = imageSettings.shadow.red;
            document.getElementById('shadowGreen').value = imageSettings.shadow.green;
            document.getElementById('shadowBlue').value = imageSettings.shadow.blue;
            
            document.getElementById('midtoneRed').value = imageSettings.midtone.red;
            document.getElementById('midtoneGreen').value = imageSettings.midtone.green;
            document.getElementById('midtoneBlue').value = imageSettings.midtone.blue;
            
            document.getElementById('highlightRed').value = imageSettings.highlight.red;
            document.getElementById('highlightGreen').value = imageSettings.highlight.green;
            document.getElementById('highlightBlue').value = imageSettings.highlight.blue;
            
            // Update displayed values
            document.getElementById('shadowRedValue').textContent = imageSettings.shadow.red;
            document.getElementById('shadowGreenValue').textContent = imageSettings.shadow.green;
            document.getElementById('shadowBlueValue').textContent = imageSettings.shadow.blue;
            
            document.getElementById('midtoneRedValue').textContent = imageSettings.midtone.red;
            document.getElementById('midtoneGreenValue').textContent = imageSettings.midtone.green;
            document.getElementById('midtoneBlueValue').textContent = imageSettings.midtone.blue;
            
            document.getElementById('highlightRedValue').textContent = imageSettings.highlight.red;
            document.getElementById('highlightGreenValue').textContent = imageSettings.highlight.green;
            document.getElementById('highlightBlueValue').textContent = imageSettings.highlight.blue;
            
            // Update current settings
            settings = JSON.parse(JSON.stringify(imageSettings));
        }
        
        function updateCurrentImage() {
            if (images.length === 0 || currentImageIndex >= images.length || !images[currentImageIndex]) {
                console.warn('尝试更新无效的图片:', currentImageIndex);
                return;
            }
            
            const image = images[currentImageIndex];
            
            // Set the original image
            const beforeImage = document.getElementById('beforeImage');
            beforeImage.src = image.original;
            
            // Apply color balance to the original image
            processImage(image.original, settings).then(processedImageData => {
                // 确保在处理完成时图片索引仍然有效
                if (currentImageIndex >= images.length || !images[currentImageIndex]) return;
                
                // Store the processed image
                image.processed = processedImageData;
                image.settings = JSON.parse(JSON.stringify(settings));
                
                // Update the after image
                const afterImage = document.getElementById('afterImage');
                afterImage.src = processedImageData;
            });
        }
        
        function processImage(imageDataUrl, settings) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Apply color balance algorithm to each pixel
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Calculate luminance
                        const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        const originalLuminance = luminance;
                        
                        let newR = r;
                        let newG = g;
                        let newB = b;
                        
                        // Apply adjustments based on luminance
                        if (luminance < 85) {
                            // Shadows
                            newR += settings.shadow.red;
                            newG += settings.shadow.green;
                            newB += settings.shadow.blue;
                        } else if (luminance >= 85 && luminance < 170) {
                            // Midtones
                            newR += settings.midtone.red;
                            newG += settings.midtone.green;
                            newB += settings.midtone.blue;
                        } else {
                            // Highlights
                            newR += settings.highlight.red;
                            newG += settings.highlight.green;
                            newB += settings.highlight.blue;
                        }
                        
                        // Ensure values are within valid range
                        newR = Math.max(0, Math.min(255, newR));
                        newG = Math.max(0, Math.min(255, newG));
                        newB = Math.max(0, Math.min(255, newB));
                        
                        // Preserve luminosity
                        const newLuminance = 0.299 * newR + 0.587 * newG + 0.114 * newB;
                        const luminanceRatio = originalLuminance / (newLuminance || 1);
                        
                        newR = Math.max(0, Math.min(255, newR * luminanceRatio));
                        newG = Math.max(0, Math.min(255, newG * luminanceRatio));
                        newB = Math.max(0, Math.min(255, newB * luminanceRatio));
                        
                        // Update pixel data
                        data[i] = newR;
                        data[i + 1] = newG;
                        data[i + 2] = newB;
                    }
                    
                    // Put processed image data back to canvas
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Return processed image as data URL
                    resolve(canvas.toDataURL('image/jpeg', 0.92));
                };
                
                img.src = imageDataUrl;
            });
        }
        
        function applyToAllImages() {
            if (images.length === 0) return;
            
            // Apply current settings to all images
            images.forEach(image => {
                image.settings = JSON.parse(JSON.stringify(settings));
            });
            
            // Process all images with new settings
            const promises = images.map(image => 
                processImage(image.original, image.settings)
                    .then(processed => {
                        image.processed = processed;
                    })
            );
            
            Promise.all(promises).then(() => {
                // Update display
                updateCurrentImage();
                
                // Show success message
                alert('已应用到所有图片');
            });
        }
        
        function resetSettings() {
            // Reset to default settings
            settings = JSON.parse(JSON.stringify(defaultSettings));
            
            // Update sliders
            updateSliders(settings);
            
            // Update current image
            updateCurrentImage();
        }
        
        function downloadImages() {
            if (images.length === 0) return;
            
            // If only one image, download directly
            if (images.length === 1) {
                const link = document.createElement('a');
                link.href = images[0].processed || images[0].original;
                link.download = "processed_" + images[0].filename;
                link.click();
                return;
            }
            
            // For multiple images, create a ZIP file
            const zip = new JSZip();
            const img_folder = zip.folder("processed_images");
            
            // Add all processed images to the ZIP
            const promises = images.map((image, index) => {
                return new Promise((resolve) => {
                    // If image is not processed yet, process it
                    if (!image.processed) {
                        processImage(image.original, image.settings).then(processed => {
                            image.processed = processed;
                            addToZip(image, index, resolve);
                        });
                    } else {
                        addToZip(image, index, resolve);
                    }
                });
            });
            
            // Helper function to add an image to the ZIP
            function addToZip(image, index, resolve) {
                // Convert data URL to blob
                fetch(image.processed)
                    .then(res => res.blob())
                    .then(blob => {
                        img_folder.file("processed_" + image.filename, blob);
                        resolve();
                    });
            }
            
            // Generate ZIP when all images are added
            Promise.all(promises).then(() => {
                zip.generateAsync({type: "blob"}).then(function(content) {
                    saveAs(content, "processed_images.zip");
                });
            });
        }
    </script>
</body>
</html>